# Migration `20201121182953-init`

This migration has been generated by JCM at 11/21/2020, 7:29:53 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "basedev_pwdlessauthnp_DB"."TokenType" AS ENUM ('EMAIL', 'API')

CREATE TYPE "basedev_pwdlessauthnp_DB"."TodoState" AS ENUM ('CREATION', 'STANDBY', 'RUNNING', 'DONE')

CREATE TYPE "basedev_pwdlessauthnp_DB"."Gender" AS ENUM ('MALE', 'FEMELE', 'UNKNOWN')

CREATE TYPE "basedev_pwdlessauthnp_DB"."Role" AS ENUM ('GUEST', 'USER', 'ADMIN', 'SUPERADMIN')

CREATE TABLE "User" (
    "id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "lastName" TEXT,
    "firstName" TEXT,
    "Role" "Role"[],
    "nickName" TEXT,
    "pwdHash" TEXT,
    "salt" TEXT,
    "social" JSONB,
    "isValidated" TIMESTAMP(3),
    "isSuspended" TIMESTAMP(3),
    "isDeleted" TIMESTAMP(3),
    "isAdmin" BOOLEAN DEFAULT false,
    "manager" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "Token" (
"id" SERIAL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "type" "TokenType" NOT NULL,
    "emailToken" TEXT,
    "valid" BOOLEAN NOT NULL DEFAULT true,
    "expiration" TIMESTAMP(3) NOT NULL,
    "userId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "Profile" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "orderProfile" INTEGER NOT NULL,
    "bio" TEXT NOT NULL,
    "isDeleted" TIMESTAMP(3),

    PRIMARY KEY ("id")
)

CREATE TABLE "Group" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "orderGroup" INTEGER NOT NULL,
    "name" TEXT NOT NULL,
    "isDeleted" TIMESTAMP(3),

    PRIMARY KEY ("id")
)

CREATE TABLE "Todo" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "orderTodo" INTEGER NOT NULL,
    "title" TEXT NOT NULL,
    "content" TEXT,
    "state" "TodoState" NOT NULL DEFAULT E'CREATION',
    "published" BOOLEAN NOT NULL DEFAULT false,
    "public" BOOLEAN NOT NULL DEFAULT false,
    "mainTodo" TEXT,
    "isDeleted" TIMESTAMP(3),

    PRIMARY KEY ("id")
)

CREATE TABLE "UserTodoLink" (
    "userId" TEXT NOT NULL,
    "todoId" TEXT NOT NULL,
    "isAuthor" BOOLEAN NOT NULL DEFAULT true,
    "isAssigned" BOOLEAN NOT NULL DEFAULT true,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    PRIMARY KEY ("userId","todoId")
)

CREATE TABLE "ForgottenPwd" (
"id" SERIAL,
    "email" TEXT NOT NULL,
    "pwdToken" TEXT NOT NULL,
    "timestamp" TIMESTAMP(3) NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "AccountValidation" (
    "id" TEXT NOT NULL,
    "isValidated" BOOLEAN NOT NULL,
    "emailToken" TEXT NOT NULL,
    "timeStamp" TIMESTAMP(3) NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "File" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "type" TEXT NOT NULL,
    "data" TEXT NOT NULL,
    "owner" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "ChangesTracking" (
"id" SERIAL,
    "doneAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "authorId" TEXT NOT NULL,
    "modelName" TEXT NOT NULL,
    "recordId" TEXT NOT NULL,
    "operation" TEXT NOT NULL,
    "newData" JSONB NOT NULL,
    "oldData" JSONB NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "Post" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "orderPost" INTEGER,
    "published" BOOLEAN NOT NULL DEFAULT false,
    "title" TEXT NOT NULL,
    "content" TEXT,
    "authorId" TEXT NOT NULL,
    "isDeleted" TIMESTAMP(3),

    PRIMARY KEY ("id")
)

CREATE TABLE "Category" (
    "id" TEXT NOT NULL,
    "orderCategory" INTEGER NOT NULL,
    "name" TEXT NOT NULL,
    "isDeleted" TIMESTAMP(3),

    PRIMARY KEY ("id")
)

CREATE TABLE "Comment" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "isDeleted" TIMESTAMP(3),
    "orderComment" INTEGER NOT NULL,
    "published" BOOLEAN NOT NULL DEFAULT false,
    "content" TEXT,
    "postId" TEXT NOT NULL,
    "authorId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "_ProfileToUser" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL
)

CREATE TABLE "_GroupToUser" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL
)

CREATE TABLE "_TodoToUser" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL
)

CREATE TABLE "_GroupToTodo" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL
)

CREATE TABLE "_CategoryToPost" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL
)

CREATE UNIQUE INDEX "User.email_unique" ON "User"("email")

CREATE UNIQUE INDEX "Token.emailToken_unique" ON "Token"("emailToken")

CREATE UNIQUE INDEX "ForgottenPwd.email_unique" ON "ForgottenPwd"("email")

CREATE UNIQUE INDEX "ForgottenPwd.pwdToken_unique" ON "ForgottenPwd"("pwdToken")

CREATE UNIQUE INDEX "AccountValidation.emailToken_unique" ON "AccountValidation"("emailToken")

CREATE UNIQUE INDEX "_ProfileToUser_AB_unique" ON "_ProfileToUser"("A", "B")

CREATE INDEX "_ProfileToUser_B_index" ON "_ProfileToUser"("B")

CREATE UNIQUE INDEX "_GroupToUser_AB_unique" ON "_GroupToUser"("A", "B")

CREATE INDEX "_GroupToUser_B_index" ON "_GroupToUser"("B")

CREATE UNIQUE INDEX "_TodoToUser_AB_unique" ON "_TodoToUser"("A", "B")

CREATE INDEX "_TodoToUser_B_index" ON "_TodoToUser"("B")

CREATE UNIQUE INDEX "_GroupToTodo_AB_unique" ON "_GroupToTodo"("A", "B")

CREATE INDEX "_GroupToTodo_B_index" ON "_GroupToTodo"("B")

CREATE UNIQUE INDEX "_CategoryToPost_AB_unique" ON "_CategoryToPost"("A", "B")

CREATE INDEX "_CategoryToPost_B_index" ON "_CategoryToPost"("B")

ALTER TABLE "User" ADD FOREIGN KEY("manager")REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "Token" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Todo" ADD FOREIGN KEY("mainTodo")REFERENCES "Todo"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "UserTodoLink" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "UserTodoLink" ADD FOREIGN KEY("todoId")REFERENCES "Todo"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "ChangesTracking" ADD FOREIGN KEY("authorId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Post" ADD FOREIGN KEY("authorId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Comment" ADD FOREIGN KEY("postId")REFERENCES "Post"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Comment" ADD FOREIGN KEY("authorId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_ProfileToUser" ADD FOREIGN KEY("A")REFERENCES "Profile"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_ProfileToUser" ADD FOREIGN KEY("B")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_GroupToUser" ADD FOREIGN KEY("A")REFERENCES "Group"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_GroupToUser" ADD FOREIGN KEY("B")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_TodoToUser" ADD FOREIGN KEY("A")REFERENCES "Todo"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_TodoToUser" ADD FOREIGN KEY("B")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_GroupToTodo" ADD FOREIGN KEY("A")REFERENCES "Group"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_GroupToTodo" ADD FOREIGN KEY("B")REFERENCES "Todo"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_CategoryToPost" ADD FOREIGN KEY("A")REFERENCES "Category"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_CategoryToPost" ADD FOREIGN KEY("B")REFERENCES "Post"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20201121182953-init
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,240 @@
+// This is your Prisma schema file,
+// learn more about it in the docs: https://pris.ly/d/prisma-schema
+
+// This is your Prisma schema file,
+// learn more about it in the docs: https://pris.ly/d/prisma-schema
+
+datasource db {
+  provider = "postgresql"
+  url = "***"
+}
+
+generator client {
+  provider = "prisma-client-js"
+  // previewFeatures = ["connectOrCreate", "transactionApi"]
+  previewFeatures = ["uncheckedScalarInputs"]
+}
+
+generator jsonSchema {
+  provider = "node node_modules/prisma-json-schema-generator"
+  // output = "custom-output-path"
+}
+
+generator dbml {
+  provider = "prisma-dbml-generator"
+}
+
+model User {
+  id          String    @default(uuid()) @id
+  email       String    @unique
+  createdAt   DateTime  @default(now())
+  updatedAt   DateTime  @default(now()) @updatedAt
+  lastName    String?
+  firstName   String?
+  Role        Role[]
+  nickName    String?
+  pwdHash     String?
+  salt        String?
+  social      Json?
+
+  // Management of the state of the account
+  isValidated  DateTime? // Null = not deleted
+  isSuspended  DateTime? // Null = not deleted
+  isDeleted    DateTime? // Null = not deleted
+  // Specific - Access right
+  isAdmin      Boolean? @default(false)
+
+  // Relation fields
+  // Inner relations
+  manager      User?             @relation("ManagerTeams", fields: [managerId], references: [id]) // Self 1 to n
+  managerId    String?           @map("manager")   // Self 1 to n
+  Team         User[]            @relation("ManagerTeams")
+  //Outside relations
+  Profiles     Profile[]         @relation(references: [id]) // implicit m:n 
+  Group        Group[]           @relation(references: [id])   // implicit m:n
+  Post         Post[]   // 1:n
+  Comment      Comment[]   // 1:n
+  Todo         Todo[]            @relation(references: [id])   // Explicit m:n
+  UserTodoLink UserTodoLink[]
+  ChangesLog   ChangesTracking[]
+  
+  // Token
+  Token         Token[]
+}
+
+model Token {
+  id        Int     @default(autoincrement()) @id
+  createdAt  DateTime  @default(now())
+  updatedAt  DateTime  @default(now()) @updatedAt
+  
+  type       TokenType
+  emailToken String?   @unique // Only used for short lived email tokens
+  valid      Boolean   @default(true)
+  expiration DateTime   
+
+  // Relation fields
+  user       User @relation(fields: [userId], references: [id])
+  userId     String
+}
+
+enum TokenType {
+  EMAIL // used as a short-lived token sent to the user's email
+  API
+}
+
+model Profile {
+  id           String   @default(uuid()) @id
+  createdAt    DateTime @default(now())
+  updatedAt    DateTime @updatedAt
+  orderProfile Int
+  // implicit m:n
+  User         User[]   @relation(references: [id])
+  bio          String
+  isDeleted    DateTime? // Null = not deleted
+}
+
+model Group {
+  id           String   @default(uuid()) @id
+  createdAt    DateTime @default(now())
+  updatedAt    DateTime @updatedAt
+  orderGroup   Int
+  name         String
+  // implicit m:n
+  User         User[]   @relation(references: [id])
+  // todo       Todo      @relation("groupTodo", fields: [todoId], references: [id])
+  // todoId     String       // relation scalar field  (used in the `@relation` attribute above
+  // implicit m:n
+  Todo         Todo[]   @relation(references: [id])
+  isDeleted    DateTime? // Null = not deleted
+}
+
+model Todo {
+  id           String        @default(uuid()) @id
+  createdAt    DateTime       @default(now())
+  updatedAt    DateTime       @updatedAt
+  orderTodo    Int
+  title        String
+  content      String?
+  state        TodoState      @default(CREATION)
+  published    Boolean        @default(false)
+  public       Boolean        @default(false)
+  mainTodo     Todo?          @relation("MainSubTodo", fields: [mainTodoId], references: [id])
+  mainTodoId   String?        @map("mainTodo")
+  SubTodo      Todo[]         @relation("MainSubTodo")
+  // Explicit m:n
+  User         User[]         @relation(references: [id])
+  // implicit m:n
+  Group        Group[]        @relation(references: [id])
+  UserTodoLink UserTodoLink[]
+  isDeleted    DateTime? // Null = not deleted
+}
+
+enum TodoState {
+  CREATION
+  STANDBY
+  RUNNING
+  DONE
+}
+
+model UserTodoLink {
+  userId      String
+  user        User     @relation(fields: [userId], references: [id])
+  todoId      String
+  todo        Todo     @relation(fields: [todoId], references: [id])
+  isAuthor    Boolean  @default(true)
+  isAssigned  Boolean  @default(true)
+  createdAt   DateTime @default(now())
+  updatedAt   DateTime @updatedAt
+
+  @@id([userId, todoId])
+}
+
+enum Gender {
+  MALE
+  FEMELE
+  UNKNOWN
+}
+
+enum Role {
+  GUEST
+  USER
+  ADMIN
+  SUPERADMIN
+}
+
+model ForgottenPwd {
+  id         Int      @default(autoincrement()) @id
+  email       String   @unique
+  pwdToken    String   @unique
+  timestamp   DateTime
+}
+
+model AccountValidation{
+  id           String   @default(uuid()) @id
+  isValidated  Boolean
+  emailToken   String   @unique
+  timeStamp    DateTime
+}
+
+model File {
+  id          String @default(uuid()) @id
+  name        String
+  type        String
+  data        String
+  owner       String
+}
+
+model ChangesTracking {
+  id           Int      @default(autoincrement()) @id
+  doneAt       DateTime @default(now())
+  modifiedBy   User     @relation(fields: [authorId], references: [id])
+  // relation scalar field  (used in the `@relation` attribute above
+  authorId     String
+  modelName    String
+  recordId     String
+  operation    String
+  newData      Json
+  oldData      Json
+}
+
+model Post {
+  id          String     @default(uuid()) @id
+  createdAt   DateTime   @default(now())
+  updatedAt   DateTime   @updatedAt
+  orderPost   Int?
+  published   Boolean    @default(false)
+  title       String
+  content     String?
+  author      User       @relation(fields: [authorId], references: [id])
+  // relation scalar field  (used in the `@relation` attribute above
+  authorId    String
+  // implicit m:n
+  Category    Category[] @relation(references: [id])
+  Comment     Comment[]
+  isDeleted   DateTime? // Null = not deleted
+}
+
+model Category {
+  id            String  @default(uuid()) @id
+  orderCategory Int
+  name          String
+  // implicit m:n
+  Post          Post[]  @relation(references: [id])
+  isDeleted     DateTime? // Null = not deleted
+}
+
+model Comment {
+  id            String   @default(uuid()) @id
+  createdAt     DateTime @default(now())
+  updatedAt     DateTime @updatedAt
+  isDeleted     DateTime? // Null = not deleted
+  orderComment  Int
+  published     Boolean  @default(false)
+  content       String?
+  post          Post     @relation(fields: [postId], references: [id])
+  // relation scalar field  (used in the `@relation` attribute above
+  postId        String
+  author        User     @relation(fields: [authorId], references: [id])
+  // relation scalar field  (used in the `@relation` attribute above
+  authorId      String
+}
```


